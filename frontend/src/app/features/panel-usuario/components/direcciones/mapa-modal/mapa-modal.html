<div class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Selecciona tu ubicación</h5>
                <button type="button" class="btn-close" (click)="cerrar()" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <!-- Se muestra si ya tenemos una dirección geocodificada (al arrastrar el marcador o seleccionar de la búsqueda) -->
                <div *ngIf="selectedAddress" class="mb-3">
                    <label class="form-label">Resultado de Ubicación (Actual)</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-light text-success"
                            [value]="selectedAddress.direccionCompleta || 'Geocodificando...'"
                            placeholder="Dirección seleccionada" readonly disabled>
                        <span class="input-group-text">
                            <i class="bi bi-pin-map-fill text-success"></i>
                        </span>
                    </div>
                    <small class="form-text text-muted">
                        Esta es la dirección obtenida de las coordenadas actuales del marcador.
                    </small>
                </div>

                <!--Botón para detectar ubicación actual -->
                <div class="d-flex gap-2 mb-3">
                    <div class="flex-grow-1">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Busca tu dirección..."
                                [(ngModel)]="searchQuery" (input)="onSearchInput()" (focus)="onSearchFocus()"
                                #searchInput>
                            <button class="btn btn-outline-secondary" type="button" aria-label="Buscar">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <!--Botón de geolocalización -->
                    <button type="button" class="btn btn-primary" (click)="detectarUbicacionActual()"
                        [disabled]="isGeolocating || isLoadingMap" title="Usar mi ubicación actual">
                        <span *ngIf="!isGeolocating">
                            <i class="bi bi-crosshair"></i>
                            📍 Mi ubicación
                        </span>
                        <span *ngIf="isGeolocating">
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            Obteniendo...
                        </span>
                    </button>
                </div>

                <!--Mensaje de error de geolocalización -->
                <div *ngIf="geoLocationError" class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {{ geoLocationError }}
                    <button type="button" class="btn-close" (click)="geoLocationError = ''" aria-label="Close"></button>
                </div>


                <!-- Resultados de búsqueda -->
                <div *ngIf="showSearchResults" class="search-results dropdown-menu show w-100 mt-1 mb-3">
                    <div *ngFor="let place of placePredictions" class="dropdown-item cursor-pointer"
                        (click)="selectPlace(place)">
                        <i class="bi bi-geo-alt-fill me-2"></i>
                        <small>{{ place.description }}</small>
                    </div>
                    <div *ngIf="placePredictions.length === 0" class="dropdown-item text-muted">
                        No se encontraron resultados
                    </div>
                </div>


                <!--Spinner mientras carga el mapa -->
                <div *ngIf="isLoadingMap" class="map-loading-overlay">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Cargando mapa...</span>
                        </div>
                        <p class="text-muted">Cargando mapa interactivo...</p>
                    </div>
                </div>

                <!-- Mapa -->
                <div #mapContainer class="map-container" [class.map-loading]="isLoadingMap"></div>

                <!--Indicador de geocodificación -->
                <div *ngIf="isGeocoding && !isLoadingMap" class="alert alert-info mt-3 mb-0">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Obteniendo información de la dirección...
                </div>

                <!-- Información de dirección seleccionada -->
                <div *ngIf="selectedAddress && !isGeocoding" class="alert alert-success mt-3">
                    <h6 class="fw-bold mb-2">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        Dirección seleccionada:
                    </h6>
                    <p class="mb-2"><strong>📍 Dirección:</strong> {{ selectedAddress.direccionCompleta }}</p>
                    <div class="row small">
                        <div class="col-md-6">
                            <strong>Distrito:</strong> {{ selectedAddress.distrito || 'N/A' }}
                        </div>
                        <div class="col-md-6">
                            <strong>Provincia:</strong> {{ selectedAddress.provincia || 'N/A' }}
                        </div>
                        <div class="col-md-6">
                            <strong>Región:</strong> {{ selectedAddress.region || 'N/A' }}
                        </div>
                        <div class="col-md-6">
                            <strong>País:</strong> {{ selectedAddress.pais || 'N/A' }}
                        </div>
                        <!--Mostrar coordenadas -->
                        <div class="col-12 mt-2 text-muted">
                            <small>
                                <i class="bi bi-geo-alt"></i>
                                Coordenadas: {{ selectedAddress.coords?.lat | number:'1.6-6' }},
                                {{ selectedAddress.coords?.lng | number:'1.6-6' }}
                            </small>
                        </div>
                    </div>
                </div>

                <!--Mensaje cuando no hay dirección seleccionada -->
                <div *ngIf="!selectedAddress && !isGeocoding && !isLoadingMap" class="alert alert-info mt-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Haz clic en el mapa o arrastra el marcador para seleccionar una ubicación
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cerrar()" [disabled]="isLoadingMap">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success"
                    [disabled]="!selectedAddress || isLoadingMap || isGeocoding" (click)="confirmarDireccion()">
                    <i class="bi bi-check-lg me-1"></i>
                    Confirmar Dirección
                </button>
            </div>
        </div>
    </div>
</div>