<h1 class="h3 fw-bold text-dark mb-4">
    <i class="fas fa-shopping-bag me-2"></i>
    Historial de Compras
</h1>

<!-- Sección de filtros -->
<div class="filtros-container mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-3">

                <!-- Filtro por fecha -->
                <div class="col-lg-8 col-md-12">
                    <label class="form-label fw-semibold text-secondary mb-2">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Filtrar por fecha
                    </label>
                    <div class="btn-group-filter">
                        <button *ngFor="let filtro of filtrosFecha" type="button" class="btn filter-btn"
                            [class.active]="filtroFechaSeleccionado === filtro.valor"
                            (click)="seleccionarFiltroFecha(filtro.valor)">
                            <i [class]="filtro.icono"></i>
                            {{ filtro.nombre }}
                            <span *ngIf="filtro.contador > 0" class="badge">{{ filtro.contador }}</span>
                        </button>
                    </div>
                </div>

                <!-- Buscador por número de pedido -->
                <div class="col-lg-4 col-md-12">
                    <label for="buscarPedido" class="form-label fw-semibold text-secondary mb-2">
                        <i class="fas fa-search me-1"></i>
                        Buscar pedido
                    </label>
                    <div class="search-container">
                        <input type="text" id="buscarPedido" class="form-control search-input"
                            placeholder="Ej: PED-2024-001234" [(ngModel)]="terminoBusqueda" (input)="buscarPorPedido()"
                            maxlength="20">
                        <i class="fas fa-search search-icon"></i>
                        <button *ngIf="terminoBusqueda" class="btn-clear-search" (click)="limpiarBusqueda()"
                            aria-label="Limpiar Busqueda" title="Limpiar Busqueda">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estado de carga -->
<div *ngIf="isLoading" class="loading-container text-center py-5">
    <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Cargando compras...</span>
    </div>
    <p class="text-muted">Cargando tu historial de compras...</p>
</div>

<!-- Mensaje cuando no hay compras -->
<div *ngIf="!isLoading && comprasFiltradas.length === 0 && !terminoBusqueda" class="empty-state text-center py-5">
    <div class="empty-icon mb-3">
        <i class="fas fa-shopping-cart"></i>
    </div>
    <h4 class="text-muted mb-3">¡Aún no has realizado compras!</h4>
    <p class="text-secondary mb-4">
        Descubre nuestros productos y realiza tu primera compra
    </p>
    <button (click)="irAlCatalogo()" class="btn btn-primary btn-lg">
        <i class="fas fa-store me-2"></i>
        Explorar Catálogo
    </button>
</div>

<!-- Mensaje cuando no hay resultados de búsqueda -->
<div *ngIf="!isLoading && comprasFiltradas.length === 0 && terminoBusqueda" class="no-results text-center py-4">
    <div class="no-results-icon mb-3">
        <i class="fas fa-search-minus"></i>
    </div>
    <h5 class="text-muted mb-2">No se encontraron resultados</h5>
    <p class="text-secondary mb-3">
        No encontramos pedidos con el término "{{ terminoBusqueda }}"
    </p>
    <button (click)="limpiarBusqueda()" class="btn btn-outline-primary">
        <i class="fas fa-times me-2"></i>
        Limpiar búsqueda
    </button>
</div>

<!-- Tabla de compras -->
<div *ngIf="!isLoading && comprasFiltradas.length > 0" class="compras-table-container">

    <!-- Header con estadísticas -->
    <div class="stats-header mb-3">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="mb-0 text-secondary">
                    Mostrando {{ comprasFiltradas.length }} de {{ comprasOriginales.length }} compras
                </h6>
            </div>
            <div class="col-md-6 text-md-end">
                <small class="text-muted">
                    Total gastado:
                    <span class="fw-bold text-success">${{ calcularTotalGastado() | number:'1.2-2' }}</span>
                </small>
            </div>
        </div>
    </div>

    <!-- Tabla responsive -->
    <div class="table-responsive shadow-sm">
        <table class="table table-hover compras-table mb-0">
            <thead class="table-header">
                <tr>
                    <th scope="col">
                        <button class="btn-sort" (click)="ordenarPor('numeroPedido')">
                            # Pedido
                            <i class="fas fa-sort" [class.fa-sort-up]="ordenAscendente && campoOrden === 'numeroPedido'"
                                [class.fa-sort-down]="!ordenAscendente && campoOrden === 'numeroPedido'"></i>
                        </button>
                    </th>
                    <th scope="col">
                        <button class="btn-sort" (click)="ordenarPor('fecha')">
                            Fecha
                            <i class="fas fa-sort" [class.fa-sort-up]="ordenAscendente && campoOrden === 'fecha'"
                                [class.fa-sort-down]="!ordenAscendente && campoOrden === 'fecha'"></i>
                        </button>
                    </th>
                    <th scope="col">Estado</th>
                    <th scope="col">Productos</th>
                    <th scope="col">
                        <button class="btn-sort" (click)="ordenarPor('total')">
                            Total
                            <i class="fas fa-sort" [class.fa-sort-up]="ordenAscendente && campoOrden === 'total'"
                                [class.fa-sort-down]="!ordenAscendente && campoOrden === 'total'"></i>
                        </button>
                    </th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let compra of comprasPaginadas; trackBy: trackByCompraId" class="compra-row"
                    [class.compra-reciente]="esCompraReciente(compra.fecha)">

                    <!-- Número de pedido -->
                    <td class="pedido-cell">
                        <div class="pedido-info">
                            <span class="pedido-numero fw-bold">{{ compra.numeroPedido }}</span>
                            <small class="pedido-id text-muted d-block">ID: {{ compra.id }}</small>
                        </div>
                    </td>

                    <!-- Fecha -->
                    <td class="fecha-cell">
                        <div class="fecha-info">
                            <span class="fecha-principal">{{ formatearFecha(compra.fecha) }}</span>
                            <small class="fecha-relativa text-muted d-block">{{ obtenerFechaRelativa(compra.fecha)
                                }}</small>
                        </div>
                    </td>

                    <!-- Estado -->
                    <td class="estado-cell">
                        <span class="badge estado-badge" [ngClass]="obtenerClaseEstado(compra.estado)">
                            <i [class]="obtenerIconoEstado(compra.estado)" class="me-1"></i>
                            {{ compra.estado }}
                        </span>
                    </td>

                    <!-- Productos -->
                    <td class="productos-cell">
                        <div class="productos-preview">
                            <div class="productos-info">
                                <span class="productos-cantidad fw-semibold">{{ compra.cantidadProductos }} producto{{
                                    compra.cantidadProductos !== 1 ? 's' : '' }}</span>
                            </div>
                        </div>
                    </td>

                    <!-- Total -->
                    <td class="total-cell">
                        <div class="total-info">
                            <span class="total-monto fw-bold text-success">${{ compra.total | number:'1.2-2' }}</span>
                            <small class="metodo-pago text-muted d-block">{{ compra.metodoPago }}</small>
                        </div>
                    </td>

                    <!-- Acciones -->
                    <td class="acciones-cell">
                        <div class="btn-group-vertical btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" (click)="openDetalleModal(compra)"
                                [title]="'Ver detalles de ' + compra.numeroPedido">
                                <i class="fas fa-eye me-1"></i>Ver</button>

                            <button *ngIf="puedeDescargarFactura(compra)" class="btn btn-outline-secondary btn-sm"
                                (click)="descargarFactura(compra)"
                                [title]="'Descargar factura de ' + compra.numeroPedido">
                                <i class="fas fa-download me-1"></i>
                                Factura
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <nav *ngIf="totalPaginas > 1" class="pagination-container mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
                Página {{ paginaActual }} de {{ totalPaginas }}
            </small>

            <nav aria-label="Navegación de páginas">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" [class.disabled]="paginaActual === 1">
                        <button class="page-link" (click)="cambiarPagina(paginaActual - 1)"
                            [disabled]="paginaActual === 1" aria-label="Página anterior" title="Página anterior">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </li>

                    <li *ngFor="let pagina of obtenerPaginasVisibles()" class="page-item"
                        [class.active]="pagina === paginaActual">
                        <button class="page-link" (click)="cambiarPagina(pagina)">{{ pagina }}</button>
                    </li>

                    <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
                        <button class="page-link" (click)="cambiarPagina(paginaActual + 1)"
                            [disabled]="paginaActual === totalPaginas" aria-label="Página siguiente"
                            title="Página siguiente">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </nav>
</div>

<!-- Call to action para hacer compras -->
<div *ngIf="!isLoading && comprasFiltradas.length > 0" class="cta-container mt-5">
    <div class="card border-0 bg-gradient-primary">
        <div class="card-body text-center py-4">
            <h5 class="card-title mb-3">
                <i class="fas fa-sparkles me-2"></i>
                ¿Listo para tu próxima compra?
            </h5>
            <p class="card-text mb-4">
                Descubre nuevos productos y ofertas especiales en nuestro catálogo
            </p>
            <button (click)="irAlCatalogo()" class="btn btn-light btn-lg">
                <i class="fas fa-store me-2"></i>
                Explorar Catálogo
            </button>
        </div>
    </div>
</div>

<!-- Modal de detalle de compra-->
<app-detalle-pedido-modal [detalle]="pedidoDetalleSeleccionado" [showModal]="mostrarModal"
    (closeModal)="closeDetalleModal()">

    <div class="modal fade" id="modalDetalleCompra" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt me-2"></i>
                        Detalle de Compra - {{ compraSeleccionada?.numeroPedido }}
                    </h5>
                    <button type="button" class="btn-close" (click)="closeDetalleModal()"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-5" *ngIf="!pedidoDetalleSeleccionado">
                        Cargando información detallada...
                    </div>
                    <div *ngIf="pedidoDetalleSeleccionado" class="detalle-compra">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeDetalleModal()"
                        data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</app-detalle-pedido-modal>