<div class="modal fade" id="crearProductoModal" tabindex="-1" aria-labelledby="crearProductoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg rounded-3">
      <!-- Header dinámico -->
      <div class="modal-header text-white">
        <h5 class="modal-title fw-bold" id="crearProductoLabel">
          <i class="bi bi-box-seam me-2"></i>
          Agregar Nuevo Producto
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <form #productForm="ngForm" (ngSubmit)="guardarProducto()">
        <div class="modal-body p-4">

          <!-- Indicador de carga -->
          <div *ngIf="isLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Guardando producto...</span>
            </div>
            <p class="mt-2 text-muted">Procesando...</p>
          </div>

          <!-- Mensaje de error -->
          <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {{ errorMessage }}
            <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
          </div>

          <div class="row g-4" [class.opacity-50]="isLoading" [class.pe-none]="isLoading">

            <!-- SECCIÓN 1: Detalles Primarios -->
            <div class="col-lg-4 col-md-6">
              <h6 class="fw-bold text-secondary mb-3">
                <i class="bi bi-info-circle me-2"></i>Detalles Primarios
              </h6>
              <div class="row g-3">

                <!-- Nombre del Producto -->
                <div class="col-12">
                  <label class="form-label fw-semibold">
                    Nombre del Producto <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" [(ngModel)]="formData.nombreProducto" name="nombreProducto"
                    placeholder="Ej: Laptop Lenovo Legion 5" required #nombreProducto="ngModel"
                    [class.is-invalid]="nombreProducto.invalid && nombreProducto.touched" />
                  <div *ngIf="nombreProducto.invalid && nombreProducto.touched" class="invalid-feedback">
                    El nombre es obligatorio
                  </div>
                </div>

                <!-- Código / SKU -->
                <div class="col-12">
                  <label class="form-label fw-semibold">Código / SKU</label>
                  <input type="text" class="form-control" [(ngModel)]="formData.codigo" name="codigo"
                    placeholder="Ej: LLG5-2023" />
                  <div class="form-text">Identificador único (opcional)</div>
                </div>

                <!-- Categoría -->
                <div class="col-12">
                  <label class="form-label fw-semibold">
                    Categoría <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" [(ngModel)]="formData.idCategoria" name="idCategoria" required
                    #idCategoria="ngModel" [class.is-invalid]="idCategoria.invalid && idCategoria.touched">
                    <option [value]="0" disabled>Selecciona una categoría</option>
                    <option *ngFor="let cat of categorias" [value]="cat.idCategoria">
                      {{ cat.nombreCategoria }}
                    </option>
                  </select>
                  <div *ngIf="idCategoria.invalid && idCategoria.touched" class="invalid-feedback">
                    Debes seleccionar una categoría
                  </div>
                  <div *ngIf="categorias.length === 0" class="form-text text-warning">
                    <i class="bi bi-exclamation-circle me-1"></i>No hay categorías disponibles
                  </div>
                </div>

                <!-- Marca -->
                <div class="col-12">
                  <label class="form-label fw-semibold">Marca</label>
                  <input type="text" class="form-control" [(ngModel)]="formData.marca" name="marca"
                    placeholder="Ej: Lenovo" />
                </div>

              </div>
            </div>

            <!-- SECCIÓN 2: Precios e Inventario -->
            <div class="col-lg-4 col-md-6">
              <h6 class="fw-bold text-secondary mb-3">
                <i class="bi bi-currency-dollar me-2"></i>Precios e Inventario
              </h6>
              <div class="row g-3">

                <!-- Precio -->
                <div class="col-12">
                  <label class="form-label fw-semibold">
                    Precio Unitario (S/.) <span class="text-danger">*</span>
                  </label>
                  <input type="number" class="form-control" [(ngModel)]="formData.precio" name="precio" step="0.01"
                    min="0.01" required #precio="ngModel" [class.is-invalid]="precio.invalid && precio.touched" />
                  <div *ngIf="precio.invalid && precio.touched" class="invalid-feedback">
                    El precio debe ser mayor a 0
                  </div>
                </div>

                <!-- Stock -->
                <div class="col-12">
                  <label class="form-label fw-semibold">
                    Stock Inicial <span class="text-danger">*</span>
                  </label>
                  <input type="number" class="form-control" [(ngModel)]="formData.stock" name="stock" min="0" required
                    #stock="ngModel" [class.is-invalid]="stock.invalid && stock.touched" />
                  <div *ngIf="stock.invalid && stock.touched" class="invalid-feedback">
                    El stock no puede ser negativo
                  </div>
                </div>

                <!-- Stock Mínimo -->
                <div class="col-12">
                  <label class="form-label fw-semibold">Stock Mínimo</label>
                  <input type="number" class="form-control" [(ngModel)]="formData.stockMinimo" name="stockMinimo"
                    min="1" placeholder="5" />
                  <div class="form-text">Alerta cuando el stock sea ≤ este valor</div>
                </div>
              </div>
            </div>

            <!-- SECCIÓN 3: Imagen Principal -->
            <div class="col-lg-4 col-12">
              <h6 class="fw-bold text-secondary mb-3">
                <i class="bi bi-image me-2"></i>Imagen Principal
              </h6>
              <div class="imagen-dropzone" (click)="!formData.imagenPreview && fileInput.click()"
                (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)"
                [class.border-primary]="formData.imagenPreview">

                <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" />

                <!-- Preview de imagen -->
                <img *ngIf="formData.imagenPreview" [src]="formData.imagenPreview" alt="Previsualización"
                  class="preview-imagen" />

                <!-- Botón eliminar -->
                <button *ngIf="formData.imagenPreview" type="button"
                  class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" (click)="eliminarImagen($event)">
                  <i class="bi bi-x-lg"></i>
                </button>

                <!-- Zona de drop vacía -->
                <div *ngIf="!formData.imagenPreview" class="contenido-dropzone">
                  <i class="bi bi-cloud-arrow-up-fill display-4 text-muted"></i>
                  <p class="mt-2">Arrastra o <strong>haz clic</strong> para seleccionar</p>
                  <small class="text-muted">JPG, PNG (Máx. 5MB)</small>
                </div>
              </div>

              <!-- Nombre del archivo -->
              <p *ngIf="formData.imagenFileName" class="mt-2 mb-0 text-dark small text-center">
                <i class="bi bi-file-earmark-image me-1"></i>{{ formData.imagenFileName }}
              </p>
            </div>

            <!-- Separador -->
            <div class="col-12">
              <hr class="my-2 border-secondary-subtle" />
            </div>

            <!-- SECCIÓN 4: Variaciones del Producto -->
            <div class="col-12">
              <h6 class="fw-bold text-secondary mb-3">
                <i class="bi bi-tags me-2"></i>Variaciones del Producto
              </h6>

              <!-- Toggle Variantes -->
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="tieneVariantes"
                  [(ngModel)]="formData.tieneVariantes" name="tieneVariantes" (change)="onTieneVariantesChange()" />
                <label class="form-check-label fw-semibold" for="tieneVariantes">
                  Este producto tiene variantes (tallas, colores, etc.)
                </label>
              </div>

              <!-- Inputs de Variantes (solo si está activado) -->
              <div *ngIf="formData.tieneVariantes" class="row g-3">

                <!-- Tallas -->
                <div class="col-md-6">
                  <div class="p-3 border rounded bg-light">
                    <label class="fw-semibold mb-2">
                      <i class="bi bi-rulers me-1"></i>Tallas (separadas por comas)
                    </label>
                    <input type="text" class="form-control" placeholder="Ej: S, M, L, XL" [(ngModel)]="tallasInput"
                      name="tallasInput" />
                    <div class="form-text mt-1">
                      Ingresa tallas separadas por comas
                    </div>
                  </div>
                </div>

                <!-- Colores -->
                <div class="col-md-6">
                  <div class="p-3 border rounded bg-light">
                    <label class="fw-semibold mb-2">
                      <i class="bi bi-palette me-1"></i>Colores (separados por comas)
                    </label>
                    <input type="text" class="form-control" placeholder="Ej: Rojo, Azul, Negro"
                      [(ngModel)]="coloresInput" name="coloresInput" />
                    <div class="form-text mt-1">
                      Ingresa colores separados por comas
                    </div>
                  </div>
                </div>

                <!-- Advertencia si no hay tallas ni colores -->
                <div class="col-12" *ngIf="formData.tieneVariantes && !tallasInput && !coloresInput">
                  <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Debes ingresar al menos tallas o colores para las variantes
                  </div>
                </div>
              </div>
            </div>

            <!-- Separador -->
            <div class="col-12">
              <hr class="my-2 border-secondary-subtle" />
            </div>

            <!-- SECCIÓN 5: Descripción -->
            <div class="col-12">
              <h6 class="fw-bold text-secondary mb-3">
                <i class="bi bi-card-text me-2"></i>Descripción
              </h6>
              <textarea class="form-control" [(ngModel)]="formData.descripcionProducto" name="descripcionProducto"
                rows="4" placeholder="Describe el producto: características, materiales, dimensiones, etc."
                maxlength="500"></textarea>
              <div class="form-text text-end">
                {{ formData.descripcionProducto?.length || 0 }} / 500 caracteres
              </div>
            </div>
          </div>
        </div>

        <!-- Footer del Modal -->
        <div class="modal-footer d-flex justify-content-between p-3 border-top">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" [disabled]="isLoading">
            <i class="bi bi-x-lg me-2"></i>Cancelar
          </button>
          <button type="submit" class="btn text-white shadow-sm"
            [disabled]="!productForm.valid || isLoading || categorias.length === 0">
            <span *ngIf="!isLoading">
              <i class="bi bi-plus-lg me-2"></i>Crear Producto
            </span>
            <span *ngIf="isLoading">
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              Guardando...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>