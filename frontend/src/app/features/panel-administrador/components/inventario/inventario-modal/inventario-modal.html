<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg rounded-3">

        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title fw-bold" id="gestionarStockLabel">
                <i class="bi bi-box-seam me-2"></i>
                Gestión de Stock: {{ productoInventario.nombreProducto }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Cerrar"></button>
        </div>

        <div class="modal-body p-4">
            <div class="row g-4">
                <!-- Sección de Ajuste de Stock -->
                <div class="col-lg-5 border-end">
                    <h6 class="fw-bold text-primary mb-3">
                        <i class="bi bi-pencil-square me-2"></i>Ajustar Stock
                    </h6>
                    <!-- Stock Actual -->
                    <div class="card text-center mb-4 border-0 p-3 shadow-sm bg-info-subtle">
                        <p class="text-muted mb-1 small fw-semibold">STOCK ACTUAL</p>
                        <h1 class="fw-bolder text-info display-5">{{ productoInventario.stock || 0 }}</h1>
                    </div>

                    <!-- Mensaje de error -->
                    <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        {{ errorMessage }}
                        <button type="button" aria-label="Cerrar-Error" class="btn-close"
                            (click)="errorMessage = null"></button>
                    </div>

                    <!-- Formulario de ajuste -->
                    <form #ajusteForm="ngForm" (ngSubmit)="registrarAjuste()">

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tipo de Movimiento</label>
                            <select class="form-select" aria-label="Tipo Movimiento" [(ngModel)]="ajuste.tipo"
                                name="tipoMovimiento" required>
                                <option value="entrada"><i class="bi bi-arrow-down-circle"></i>Entrada (Aumentar)
                                </option>
                                <option value="salida"><i class="bi bi-arrow-up-circle"></i>Salida (Reducir)</option>
                                <option value="AJUSTE"><i class="bi bi-pencil-square"></i> Ajuste Manual</option>
                            </select>
                        </div>


                        <div class="mb-3">
                            <label class="form-label fw-semibold">Cantidad <span class="text-danger">*</span></label>
                            <input type="number" aria-label="Aumentar cantidad" class="form-control form-control-lg"
                                [(ngModel)]="ajuste.cantidad" name="cantidad" min="1"
                                [max]="ajuste.tipo === 'SALIDA' ? productoInventario.stock : 99999" required />
                            <small class="text-muted" *ngIf="ajuste.tipo === 'SALIDA'">
                                Máximo disponible: {{ productoInventario.stock }}
                            </small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold">Razón / Comentario (Opcional)<span
                                    class="text-danger">*</span></label>
                            <textarea class="form-control" aria-label="Razon Comentario" [(ngModel)]="ajuste.motivo"
                                name="motivoAjuste" rows="3"
                                placeholder="Ej: Compra a proveedor, Venta perdida, Corrección de inventario..."
                                required></textarea>
                        </div>


                        <button type="submit" class="btn btn-lg btn-primary w-100 fw-bold shadow-sm"
                            [disabled]="ajusteForm.invalid || isSaving">
                            <i class="bi bi-save me-2"></i>
                            {{ isSaving ? 'Guardando...' : 'Guardar Ajuste' }}
                        </button>
                    </form>
                </div>

                <!-- Sección de Historial -->
                <div class="col-lg-7">
                    <h6 class="fw-bold text-primary mb-3">
                        <i class="bi bi-clock-history me-2"></i>Historial de Movimientos
                    </h6>

                    <div *ngIf="historialMovimientos.length === 0" class="alert alert-info text-center" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        No hay movimientos registrados para este producto.
                    </div>

                    <div *ngIf="historialMovimientos.length > 0" class="table-responsive shadow-sm border rounded">
                        <table class="table table-sm table-striped table-hover mb-0">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th class="dato-fecha">Fecha</th>
                                    <th class="dato-ajuste">Ajuste</th>
                                    <th class="dato-stock">Stock Final</th>
                                    <th class="dato-razon">Razón</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let movimiento of historialMovimientos">
                                    <td class="small">
                                        {{ movimiento.fechaMovimiento | date: 'dd/MM/yy HH:mm' }}
                                    </td>
                                    <td>
                                        <span class="badge" [ngClass]="{
                                                'bg-success': movimiento.tipoMovimiento === 'ENTRADA',
                                                'bg-danger': movimiento.tipoMovimiento === 'SALIDA',
                                                'bg-info': movimiento.tipoMovimiento === 'AJUSTE',
                                                'bg-warning': movimiento.tipoMovimiento === 'DEVOLUCION'
                                            }">
                                            <i [class]="getTipoMovimientoIcon(movimiento.tipoMovimiento)"></i>
                                            {{ getTipoMovimientoTexto(movimiento.tipoMovimiento) }}
                                        </span>
                                    </td>
                                    <td class="text-center fw-bold">
                                        <span [ngClass]="{
                                            'text-success': movimiento.stockNuevo > movimiento.stockAnterior,
                                            'text-danger': movimiento.stockNuevo < movimiento.stockAnterior
                                        }">
                                            {{ getCambioStock(movimiento) }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">
                                            {{ movimiento.stockNuevo }}
                                        </span>
                                    </td>
                                    <td class="small text-muted">
                                        {{ movimiento.motivo || 'Sin comentario' }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer d-flex justify-content-end p-3 border-top">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-lg me-2"></i> Cerrar
            </button>
        </div>

    </div>
</div>